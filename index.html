<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>کم‌کننده حجم عکس | Image Compressor</title>
  <meta name="description" content="کاهش حجم و تغییرسایز تصاویر به صورت آفلاین و سمت کاربر" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --ring:#334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial;
      background:radial-gradient(1200px 600px at 80% -10%, #0b1229 20%, transparent), var(--bg);
      color:var(--text); line-height:1.6;
      display:flex; flex-direction:column; align-items:center; padding:24px;
    }
    .wrap{max-width:980px; width:100%}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px}
    h1{font-size:clamp(20px,4vw,28px); margin:0}
    .badge{font-size:12px; color:#0f172a; background:var(--accent); padding:4px 10px; border-radius:999px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.00));
      border:1px solid var(--ring); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .controls{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-top:8px}
    .controls label{font-size:13px; color:var(--muted)}
    .controls .row{display:flex; gap:10px; align-items:center}
    input[type="number"], select, input[type="range"]{
      width:100%; background:#0b1223; color:var(--text); border:1px solid var(--ring);
      padding:10px 12px; border-radius:12px; outline:none;
    }
    input[type="range"]{padding:0; height:36px}
    .btn{
      background:#0b1223; border:1px solid var(--ring); color:var(--text);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s; white-space:nowrap
    }
    .btn:hover{border-color:var(--accent)}
    .drop{
      margin-top:14px; background:#0b1223; border:2px dashed var(--ring); border-radius:16px; padding:28px;
      text-align:center; transition:.2s; cursor:pointer
    }
    .drop.dragover{border-color:var(--accent); background:#081022}
    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:12px; margin-top:16px}
    .item{background:#0b1223; border:1px solid var(--ring); border-radius:14px; overflow:hidden}
    .thumb{aspect-ratio:1.2/1; display:flex; align-items:center; justify-content:center; background:#070e1c; overflow:hidden}
    .thumb img{max-width:100%; max-height:100%; display:block}
    .meta{padding:10px; display:grid; gap:6px; font-size:13px}
    .meta .row{display:flex; justify-content:space-between; gap:8px; color:var(--muted)}
    .meta .save{display:flex; gap:8px}
    .muted{color:var(--muted)}
    .footer{margin-top:22px; font-size:12px; color:var(--muted)}
    .hidden{display:none}
    @media (max-width:640px){ .controls{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>کم‌کننده حجم عکس <span class="badge">4X Company</span></h1>
      <button id="clearAll" class="btn" title="حذف نتایج">پاک‌سازی</button>
    </header>

    <section class="card">
      <div class="controls">
        <div>
          <label>کیفیت خروجی (٪)</label>
          <input id="quality" type="range" min="1" max="100" value="80" />
        </div>
        <div>
          <label>حداکثر عرض (px) — اگر عکس کوچک‌تر باشد دست‌نخورده می‌ماند</label>
          <input id="maxWidth" type="number" min="200" max="8000" value="1600" />
        </div>
        <div class="row">
          <label>فرمت خروجی</label>
          <select id="format">
            <option value="image/jpeg">JPEG (.jpg)</option>
            <option value="image/webp">WebP (.webp)</option>
            <option value="image/png">PNG (.png)</option>
          </select>
        </div>
        <div class="row">
          <input id="keepSize" type="checkbox" />
          <label for="keepSize">حفظ ابعاد اصلی (فقط فشرده‌سازی)</label>
        </div>
      </div>

      <div id="drop" class="drop">
        <p class="muted">عکس‌ها را اینجا بکشید و رها کنید یا کلیک کنید برای انتخاب</p>
        <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
        <div style="margin-top:8px; display:flex; justify-content:center; gap:10px">
          <button id="chooseBtn" class="btn">انتخاب فایل</button>
          <button id="demoBtn" class="btn" title="یک نمونه کوچک آزمایشی">افزودن نمونه</button>
        </div>
      </div>
    </section>

    <div id="grid" class="grid"></div>
    <div class="footer">تمام پردازش‌ها روی مرورگر شما انجام می‌شود و فایل‌ها جایی آپلود نمی‌شوند. ولی ببین به قرآن مجید اگه بیای از سایت اسکی بری زندت نمیزارم. طراحی شده با ❤ توسط میر سینا بنی هاشم</div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const grid = $("#grid");
    const drop = $("#drop");
    const fileInput = $("#fileInput");
    const chooseBtn = $("#chooseBtn");
    const demoBtn = $("#demoBtn");
    const clearAllBtn = $("#clearAll");
    const qualityEl = $("#quality");
    const maxWidthEl = $("#maxWidth");
    const keepSizeEl = $("#keepSize");
    const formatEl = $("#format");

    let processingQueue = 0;

    function formatBytes(b){
      if (!b && b !== 0) return "-";
      const u = ["B","KB","MB","GB"]; let i=0; let n=b;
      while(n>=1024 && i<u.length-1){ n/=1024; i++; }
      return n.toFixed(n<10 && i>0 ? 2:1)+" "+u[i];
    }
    function pctSaved(oldB,newB){
      if(!oldB || !newB) return "—";
      const saved = Math.max(0, oldB - newB);
      return ((saved/oldB)*100).toFixed(0) + "%";
    }

    function setDrag(on){ drop.classList.toggle("dragover", !!on); }

    drop.addEventListener("click", ()=> fileInput.click());
    chooseBtn.addEventListener("click", (e)=>{ e.stopPropagation(); fileInput.click(); });

    ["dragenter","dragover"].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); setDrag(true); }));
    ["dragleave","dragend","drop"].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); setDrag(false); }));
    drop.addEventListener("drop", e=>{
      const files = [...(e.dataTransfer?.files || [])];
      if (files.length) handleFiles(files);
    });
    fileInput.addEventListener("change", e=>{
      const files = [...(e.target.files || [])];
      if (files.length) handleFiles(files);
      fileInput.value = "";
    });

    demoBtn.addEventListener("click", ()=>{
      // تولید یک تصویر نمونه کوچک روی پرواز (بدون دانلود فایل خارجی)
      const canvas = document.createElement("canvas");
      canvas.width = 1200; canvas.height = 800;
      const ctx = canvas.getContext("2d");
      const grad = ctx.createLinearGradient(0,0,1200,800);
      grad.addColorStop(0,"#222");
      grad.addColorStop(1,"#555");
      ctx.fillStyle = grad; ctx.fillRect(0,0,1200,800);
      ctx.fillStyle="#fff"; ctx.font="48px sans-serif";
      ctx.fillText("Sample Image", 40, 100);
      ctx.font="28px sans-serif";
      ctx.fillText("Drag & Drop works!", 40, 160);
      canvas.toBlob(blob=>{
        const file = new File([blob], "sample.jpg", {type:"image/jpeg", lastModified:Date.now()});
        handleFiles([file]);
      }, "image/jpeg", .92);
    });

    clearAllBtn.addEventListener("click", ()=>{
      grid.innerHTML = "";
    });

    async function handleFiles(files){
      for(const file of files){
        if(!file.type.startsWith("image/")) continue;
        const card = createItemCard(file);
        grid.prepend(card.el);
        processImage(file, card).catch(err=>{
          card.setStatus("خطا در پردازش");
          console.error(err);
        });
      }
    }

    function createItemCard(file){
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="thumb"><span class="muted">در حال پردازش…</span></div>
        <div class="meta">
          <div class="row"><span>${file.name}</span><span class="muted">${(file.type||"").replace("image/","").toUpperCase()}</span></div>
          <div class="row"><span>حجم اصلی</span><span id="origSize">${formatBytes(file.size)}</span></div>
          <div class="row"><span>حجم خروجی</span><span id="newSize">—</span></div>
          <div class="row"><span>صرفه‌جویی</span><span id="saved">—</span></div>
          <div class="save">
            <a id="download" class="btn" download>دانلود</a>
            <button id="reprocess" class="btn" title="بازپردازش با تنظیمات فعلی">اعمال دوباره</button>
          </div>
        </div>
      `;
      const dom = {
        el,
        thumb: el.querySelector(".thumb"),
        origSize: el.querySelector("#origSize"),
        newSize: el.querySelector("#newSize"),
        saved: el.querySelector("#saved"),
        download: el.querySelector("#download"),
        reprocess: el.querySelector("#reprocess"),
        setThumb(node){ this.thumb.innerHTML=""; this.thumb.appendChild(node); },
        setStatus(t){ this.thumb.innerHTML=`<span class="muted">${t}</span>`; }
      };
      dom.reprocess.addEventListener("click", ()=>{
        processImage(file, dom, /*force*/true).catch(console.error);
      });
      return dom;
    }

    function loadImageAsURL(file){
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onerror = rej;
        fr.onload = ()=> res(fr.result);
        fr.readAsDataURL(file);
      });
    }

    async function processImage(file, card, force=false){
      processingQueue++;
      try {
        card.setStatus("در حال پردازش…");

        const url = await loadImageAsURL(file);
        const img = new Image();
        img.decoding = "async";
        img.src = url;
        await img.decode();

        const maxWidth = parseInt(maxWidthEl.value||1600, 10);
        const quality = Math.min(1, Math.max(0.01, (+qualityEl.value||80)/100));
        const outType = formatEl.value || "image/jpeg";
        const keepSize = keepSizeEl.checked;

        // محاسبه ابعاد هدف
        let targetW = img.naturalWidth;
        let targetH = img.naturalHeight;
        if(!keepSize && img.naturalWidth > maxWidth){
          const ratio = maxWidth / img.naturalWidth;
          targetW = Math.round(img.naturalWidth * ratio);
          targetH = Math.round(img.naturalHeight * ratio);
        }

        // رسم روی بوم
        const canvas = document.createElement("canvas");
        canvas.width = targetW; canvas.height = targetH;
        const ctx = canvas.getContext("2d");
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(img, 0, 0, targetW, targetH);

        const blob = await new Promise(res=> canvas.toBlob(res, outType, outType==="image/png" ? 1 : quality));
        const outURL = URL.createObjectURL(blob);

        // پیش‌نمایش
        const preview = new Image();
        preview.src = outURL;
        preview.alt = "پیش‌نمایش";
        card.setThumb(preview);

        // متادیتا و دانلود
        card.newSize.textContent = formatBytes(blob.size);
        card.saved.textContent = pctSaved(file.size, blob.size);
        const ext = (outType.split("/")[1] || "jpg").replace("jpeg","jpg");
        const base = file.name.replace(/\.[^.]+$/, "");
        card.download.href = outURL;
        card.download.download = `${base}-compressed.${ext}`;
      } finally {
        processingQueue--;
      }
    }
  </script>
</body>
</html>